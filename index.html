<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <title> VENTAS </title>
    <script type="text/javascript">

        "use strict";

        var note = document.getElementById('notifications');
        var data = {};
        data.newItem = { desc: "", precio: 0.0 };
        
        var errorFun = function(e) { note.innerHTML += '<li>Error loading database.</li>'; };
        
        function loadDB() {
            note.innerHTML += '<li>App initialized.</li>';

            var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
//            window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
            
            var req = indexedDB.open("datos");
            req.onerror = errorFun;
            req.onsuccess = function(e) { note.innerHTML += '<li>Database initialized.</li>'; data.datos = req.result; };
            re.onupgradeneeded = function(e) {
                var db = event.taget.result;
                db.onerror = errorFun;
                
                var objStore = db.createObjectStore('datos', { keyPath: 'clave' } );
                objStore.createIndex('desc', 'desc', { unique: false } );
                
                note.innerHTML += '<li> ObjectStore created. </li>';
            };
        }

        function populateDB() {
            var xhttp = new XMLHttpRequest();
            xhttp.open('GET', 'ferre.json');
            xhttp.onreadystatechange = function() {
                if (xhttp.readyState == 4) {
                    var datos = eval( '(' +  xhttp.responseText + ')' );
                    
                    var transaction = data.datos.transaction(['datos'], 'readwrite');
                    transaction.onerror = function () { note.innerHTML += '<li> Transaction not opened due to error. </li>'; };
                    var objStore = transaction.objectSore('datos');

                    for (i=0; i<datos.length; i++) {
                        objStore.add( datos[i] );
                    }
                    
                    note.innerHTML += '<li> Data loaded to DB. </li>';
                }
            };
            xhttp.send(null);
        }
                  
        function inputChange(e) {
            e.target.value = "";
            searchRequest(e);
        }
        
        function keyPressed(e) {
            if (e.key == 'Escape') {
                e.target.value = "";
            }
        }
        
        function searchRequest(e) {
            var xhttp = new XMLHttpRequest();
            xhttp.open('GET', '/' + e.target.value);
            xhttp.onreadystatechange = function() {
                console.log('State value: ' + xhttp.readyState + '\n');
            };
            xhttp.send(null);
        }
     
    </script>
</head>

<body>

    <header> <button value="load" onclick="populateDB()"> LOAD </button> </header>

    <section id="buscar">
        <label> Buscar: <input type="search" size=40 placeholder="Art&iacute;culo o Clave" onchange="inputChange(event);" onkeypress="keyPressed(event);"> </label>
    </section>

    <section id="resultados">
        <table>
            <caption> Resultados de b&uacute;squeda </caption>
            <thead>
                <tr> <th width=40> Descripci&oacute;n </th> <th> Precio </th> </tr>
            </thead>
            <tbody id="tabla-resultados"> </tbody>
        </table>
    </section>
    
    <footer> <ul id="notifications"> </ul> </footer>
    
</body>
</html>
