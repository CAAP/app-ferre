<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <title> VENTAS </title>
    <script type="text/javascript">

        "use strict";

        const DB_NAME = 'datos';
        const DB_VERSION = 1;
        const DB_STORE_NAME = 'datos-clave';
        
        var note = document.getElementById('notifications');
        var ans = document.getElementById('tabla-resultados');
        var data = {};
        var errorFun = function(e) { note.innerHTML += '<li>Error loading database.</li>'; };
        var IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;;

        function loadDB() {
            var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

            var req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onerror = function(e) { note.innerHTML += '<li>Error loading database: '+ e.target.errorCode + '. </li>'; };
            req.onsuccess = function(e) { note.innerHTML += '<li>Database initialized.</li>'; data.datos = e.target.result; };
            req.onupgradeneeded = function(e) {
                note.innerHTML += '<li>Upgrade ongoing.</li>';
                
                var objStore = e.target.result.createObjectStore(DB_STORE_NAME, { keyPath: "clave" });
                objStore.createIndex("desc", "desc", { unique: false } );
                objStore.transaction.oncomplete = function(e) {
                    note.innerHTML += '<li> ObjectStore created. Ready to add data into it. </li>';
                }

            };
        }

        function write2DB() {
            var transaction = data.datos.transaction(DB_STORE_NAME, "readwrite");
            transaction.oncomplete = function(e) { note.innerHTML += '<li> RW transaction successfully done. </li>' };
            transaction.onerror = function(e) { note.innerHTML += '<li> RW transaction error:' + e.target.errorCode + '. </li>' };
            
            var objStore = transaction.objectStore(DB_STORE_NAME);
            return objStore;
        }
        
        function readDB() {
            var transaction = data.datos.transaction(DB_STORE_NAME);
            transaction.oncomplete = function(e) { note.innerHTML += '<li> ROnly transaction successfully done. </li>' };
            transaction.onerror = function(e) { note.innerHTML += '<li> ROnly transaction error:' + e.target.errorCode + '. </li>' };
            
            var ojbStore = transaction.objectStore(DB_STORE_NAME);
            return objStore;
        }
        
        function searchByDesc(s) {
            var index = readDB().index("desc");
            var descRange = IDBKeyRange.lowerBound(s);
            index.openCursor( descRange ).onsuccess = function(e) {
                var cursor = e.target.result;
                if (cursor) {
                    var item = "<tr><td>" + cursor.desc + "</td> <td>" + cursor.precio + "</td></tr>";
                    ans.innerHTML += item;
                    cursor.continue();
                }
            };
        }
        
        function populateDB() {
            var xhttp = new XMLHttpRequest();
            xhttp.open('GET', 'ferre.json');
            xhttp.onreadystatechange = function() {
                if (xhttp.readyState == 4) {
                    var datos = eval( '(' +  xhttp.responseText + ')' );
                    
                    var objStore = write2DB();
                    for (i=0; i<datos.length; i++) { objStore.add( datos[i] ); }
                    
                    note.innerHTML += '<li> Data loaded to DB. </li>';
                }
            };
            xhttp.send(null);
        }
                  
        function inputChange(e) {
            searchByDesc(e.taget.value);
            e.target.value = "";
        }
        
        function keyPressed(e) {
            if (e.key == 'Escape') {
                e.target.value = "";
            }
        }

    </script>
</head>

<body>

    <header> <button value="load" onclick="populateDB()"> LOAD </button> </header>

    <section id="buscar">
        <label> Buscar: <input type="search" size=40 placeholder="Art&iacute;culo o Clave" onchange="inputChange(event);" onkeypress="keyPressed(event);"> </label>
    </section>

    <section id="resultados">
        <table>
            <caption> Resultados de b&uacute;squeda </caption>
            <thead>
                <tr> <th width=40> Descripci&oacute;n </th> <th> Precio </th> </tr>
            </thead>
            <tbody id="tabla-resultados"> </tbody>
        </table>
    </section>
    
    <footer> <ul id="notifications"> </ul> </footer>
    
</body>
</html>
