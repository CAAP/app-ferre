<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <title> VENTAS </title>
    <script type="text/javascript">

        "use strict";

        const DB_NAME = 'datos';
        const DB_VERSION = 2;
        const DB_STORE_NAME = 'datos-clave';
        
        var note;
        var ans;
        var data = {};
        var IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

        function write2DB() {
            var transaction = data.datos.transaction(DB_STORE_NAME, "readwrite");
            transaction.oncomplete = function(e) { note.innerHTML += '<li> RW transaction successfully done. </li>' };
            transaction.onerror = function(e) { note.innerHTML += '<li> RW transaction error:' + e.target.errorCode + '. </li>' };
            
            var objStore = transaction.objectStore(DB_STORE_NAME);
            return objStore;
        }
        
        function readDB() {
            var transaction = data.datos.transaction(DB_STORE_NAME);
            transaction.oncomplete = function(e) { note.innerHTML += '<li> Read transaction successfully done. </li>' };
            transaction.onerror = function(e) { note.innerHTML += '<li> Read transaction error:' + e.target.errorCode + '. </li>' };
            
            return transaction.objectStore(DB_STORE_NAME);
        }
 
        function populateDB() {
            var xhttp = new XMLHttpRequest();
            xhttp.open('GET', 'ferre.json');
            xhttp.onreadystatechange = function() {
                if (xhttp.readyState == 4) {
                    var datos = eval( '(' +  xhttp.responseText + ')' );
                    
                    var objStore = write2DB();
                    for (var i in datos) { objStore.add( datos[i] ); }
                    
                    note.innerHTML += '<li> Data loaded to DB. </li>';
                }
            };
            xhttp.send(null);
        }
       
        function searchByDesc(s) {
	    ans.innerHTML = '';

            var index = readDB().index("desc");
            var descRange = IDBKeyRange.lowerBound(s);
	    var k = 0;
            index.openCursor( descRange ).onsuccess = function(e) {
                var cursor = e.target.result;
                if (cursor) {
                    var item = "<tr><td>" + cursor.value.desc + "</td> <td>" + cursor.value.precio + "</td> <td>" + cursor.value.fecha + "</td></tr>";
                    ans.innerHTML += item;
		    k++;
		    if (k == 5) { return; }
                    cursor.continue();
                }
            };
        }
 
	window.onload = function() {
            note = document.getElementById('notifications');
            ans = document.getElementById('tabla-resultados');

        var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

            var req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onerror = function(e) { note.innerHTML += '<li>Error loading database: '+ e.target.errorCode + '. </li>'; };
            req.onsuccess = function(e) { note.innerHTML += '<li>Database initialized.</li>'; data.datos = this.result; };
            req.onupgradeneeded = function(e) {
                note.innerHTML += '<li>Upgrade ongoing.</li>';
                
                var objStore = e.currentTarget.result.createObjectStore(DB_STORE_NAME, { keyPath: "clave" });
                objStore.createIndex("desc", "desc", { unique: false } );
                objStore.transaction.oncomplete = function(e) {
                    note.innerHTML += '<li> ObjectStore created. Ready to add data into it. </li>';
		    populateDB();
                }

            };
        };

	window.onclose = function() {
        var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

	    var req = indexedDB.deleteDatabase(DB_NAME);
	    req.onerror = function(e) { console.log("Error deleting database."); };
	    req.onsuccess = function(e) { console.log("Database deleted successfully.") };
	}

       
                 
        function inputChange(e) {
            searchByDesc(e.target.value);
            e.target.value = "";
        }
        
        function keyPressed(e) {
            if (e.key == 'Escape') {
                e.target.value = "";
            }
        }

    </script>
</head>

<body>

    <header> <button value="load"> LOAD </button> </header>

    <section id="buscar">
        <label> Buscar: <input type="search" size=40 placeholder="Art&iacute;culo o Clave" onchange="inputChange(event);" onkeypress="keyPressed(event);"> </label>
    </section>

    <section id="resultados">
        <table>
            <caption> Resultados de b&uacute;squeda </caption>
            <thead>
                <tr> <th width=40> Descripci&oacute;n </th> <th> Precio </th> <th> Fecha </th> </tr>
            </thead>
            <tbody id="tabla-resultados"> </tbody>
        </table>
    </section>
    
    <footer> <ul id="notifications"> </ul> </footer>
    
</body>
</html>
